=============================================
ДКР
=============================================

Тема
----------

Периферійний модуль таймера для MIPS-подібного ядра


Документація
-------------

Під час виконання ДКР за технічним завданням був розроблений модуль таймера для MIPS-подібного ядра.
Усі функції, що були наведені у технічному завданні, присутні.

Архітекрурний стан таймера задається п'ятьма регістрами: самого лічильника зі входом дозволу, синхронного скидання та напрямку рахунку ``TCNT``; трьох регістрів порівняння ``OCRA, OCRB i OCRC``, та регістра управління ``TCCR``. Всі регістри відображено у пам'ять з можливістю читання та запису. Лічильник таймера може рахувати у двох напрямках - угору, зі скиданням в 0 по досягненні TOP, або вниз - з завантаженням TOP при досягненні 0.
Значення TOP конфігуроване і може бути вибране з отирьох варіантів: будь-який регістр OCR або значення 0xffffffff.


.. image:: media/tccr.png

Так виглядає схема регістру керування таймером. Описання керуючих бітів 
встановлено нижче.


``0.`` E - enable, дозволяє лічильнику рахунок.

``1-2.`` TOP - вибір джерела для верхньої границі лічильника:

    - 00: 0xffffffff
    - 01: OCRA
    - 10: OCRB
    - 11: OCRC


``3.`` D - напрямок рахунку, 0 - угору, 1 - униз.

``4, 6, 8`` - біти дозволу виходу ШИМу, при скинутих бітах на виходах ШИМу константний логічний 0.

``5, 7, 9`` - біти інверсії заданого каналу ШИМ.

``10, 11, 12, 13`` - біти дозволу переривань по порівнянню каналів A, B, C, та по переповненню відповідно.

``14`` - біт вибору джерела тактування. Якщо 0, вхід тактується системною частотою, поділеною у 2^PRESC разів. Якщо 1, тактується зі входу зовнішнього тактування.

``15-19`` - поле PRESC, попередній подільник для системної частоти. Системна частота ділиться у 2^PRESC разів та використовується як частота рахунку, якщо
біт CS скинутий. При встановленому біті CS ігнорується.

``20-24`` - поле, що визначає, який саме пін GPIO використовуватиметься як джерело зовнішнього тактування. При скинутому біті CS ігнорується.

``25-27`` - невикористані біти, вони не впливають на роботу модуля ніяким чином.

``28-32`` - флаги переривань, що встановлюються перериванням, використовуються для програмного опитування стану таймера. Повинні бути скинуті програмно після обробки переривання.

У модуль GPIO також були додані два регістри AF1 та AF2, шо являють собою єдиний 64-бітний регістр AF. При цьому у кожного піна є поле з двох бітів,
які визначають, що буде подано на пін у режимі виходу: значення регістра PORT або один з трьох ШИМ-каналів. Поля пінів розміщені у регістрі послідовно, кожен
пін по зміщенню 2*N, де N - номер піна. Значення 0 виводить на пін значення відповідного біту регістра PORT, значення 1 - ШИМ-канал A, значення 2 - B, 3 - C.
Регістр DDR має більш високий пріоритет, ніж цей регістр: на піни, що задані на вхід, вміст регістру AF не впливатиме.


Регістри розташовані за наступними адресами:


======== ======
address  periph
======== ======
0x0-0xf7 RAM
0x80     DDR
0x81     PORT
0x82     PIN
0x83     AF1
0x84     AF2
0x85     TCNT
0x86     OCRA
0x87     OCRB
0x88     OCRC
0x89     TCCR
======== ======

